<!doctype html>
<meta charset="utf-8" />
<title>Music Sheet</title>

<link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.2/css/bootstrap.min.css"/>
<script src="http://fb.me/react-0.12.2.js"></script>
<script>
	console.warn('react non-minified version')
</script>
<script src="http://fb.me/JSXTransformer-0.12.2.js"></script>
<script src="./node_modules/bencode-js/bencode-min.js"></script>


<style type="text/css">
	@import url(http://fonts.googleapis.com/css?family=Asul:400,700);
	#paper-wrapper {
	}
	.sheet {
		/*border:1px solid blue;*/
	}
	.sheet-row {
		line-height:110px;
		margin-top:20px;
		padding-bottom:20px;
		border-bottom:1px solid #aaa;
	}
	.sheet-row:last-child {
		border:none;
	}
	.sheet-bar-separator, .sheet-signature, .sheet-bar {
		display:inline-block;
		vertical-align:middle;
		line-height:20px;
		font-family:'Asul', sans-serif;
		color:#414141;
		font-weight:700;
	}
	.sheet-bar {
		position:relative;
		width:124px;
		height:90px;
		box-sizing:border-box;
	}
	.sheet-bar  + .sheet-bar {
	}
	.sheet-bar.bad-bar {
		color:red;
		background-position-Y:50%;
	}
	.sheet-bar.bar-3 {
		background-image:url(bar-3.png);
	}
	.sheet-bar.bar-4 {
		background-image:url(bar-4.png);
	}
	.sheet-bar.bar-3.b_1-1-1  	{ background-position-x:-238px; }
	.sheet-bar.bar-3.b_1-2    	{ background-position-x:0; }
	.sheet-bar.bar-3.b_2-1    	{ background-position-x:-124px; }
	.sheet-bar.bar-3.b_3      	{ background-image:none; }
	.sheet-bar.bar-4.b_1-1-1-1	{ background-position-x:-620px; }
	.sheet-bar.bar-4.b_1-1-2  	{ background-position-x:-372px; }
	.sheet-bar.bar-4.b_1-2-1  	{ background-position-x:-744px; }
	.sheet-bar.bar-4.b_1-3    	{ background-position-x:0; }
	.sheet-bar.bar-4.b_2-1-1  	{ background-position-x:-496px; }
	.sheet-bar.bar-4.b_2-2    	{ background-position-x:-124px; }
	.sheet-bar.bar-4.b_3-1    	{ background-position-x:-248px; }
	.sheet-bar.bar-4.b_4      	{ background-image:none; }

	.sheet-signature {
		text-align:center;
		font-size: 1.4em;
		width:35px;
	}
	.sheet-signature:first-child {
		margin-left: -35px;
	}
	.sheet-bar-sep {
		border-left:2px solid #666;
		height: 30px;
		margin:0 20px;
	}

	.sheet-step {
		font-size: 18px;
		position:absolute;
		width:100%;
		padding:0 5px;
	}
	/* positionement des steps dans une bar 4 */
	.bar-4 .sheet-step.s_0-1 {top:33px;text-align:left;}
	.bar-4 .sheet-step.s_0-2 {top:20px;text-align:left; padding:0 15px;}
	.bar-4 .sheet-step.s_0-3 {top:14px;text-align:center;}
	.bar-4 .sheet-step.s_0-4 {top:32px;text-align:center;}
	.bar-4 .sheet-step.s_1-1 {text-align:center; padding:5px;}
	.bar-4 .sheet-step.s_1-2 {top:20px;text-align:right; padding:0 15px; }
	.bar-4 .sheet-step.s_1-3 {top:33px;text-align:right; padding:0 15px;}
	.bar-4 .sheet-step.s_2-1 {top:33px;text-align:right;}
	.bar-4 .sheet-step.s_2-2 {top:52px;text-align:right; padding:0 15px;}
	.bar-4 .sheet-step.s_3-1 {top:62px;text-align:center;}

	.bar-3 .sheet-step.s_0-1 {text-align:left; padding:5px;}
	.bar-3 .sheet-step.s_0-2 {top:20px;text-align:left; padding:0 15px;}
	.bar-3 .sheet-step.s_0-3 {top:32px;text-align:center;}
	.bar-3 .sheet-step.s_1-1 {top:32px;text-align:center;}
	.bar-3 .sheet-step.s_1-2 {top:52px;text-align:right; padding:0 15px;}

	.bar-3 .sheet-step.s_2-1 {top:62px;text-align:right;}

</style>

<div id="paper-wrapper" class="container">

</div>

<script type="text/jsx">

	var DEFAULT_SIGNATURE_BEATS = 4
	var DEFAULT_SIGNATURE_SIZE = 4

	var Paper = React.createClass({
		render: function() {
			return (
				<div>
					<h1>{this.props.title}</h1>
					<Sheet {...this.props}/>
				</div>
			)
		}
	})
	var Sheet = React.createClass({
		render: function() {
			var rows = this.props.rows
			var htmlRows = rows.map(function(row) {
				return (
					<HtmlRow row={row}/>
				)
			})
			return (
				<div className="sheet">
					{htmlRows}
				</div>
			)
		}
	})
	var HtmlRow = React.createClass({
		render: function() {
			var htmlBars = this.props.row.map(function(e) {
				if (e instanceof Bar)
					return (<HtmlBar bar={e}/>)
				else if (e instanceof BarSeparator)
					return (<div className="sheet-bar-separator sheet-bar-sep"></div>)
				else if (e instanceof Signature)
					return (<HtmlSignature signature={e}/>)
			})
			return (
				<div className="sheet-row">
					{htmlBars}
				</div>
			)
		}
	})
	var HtmlBar = React.createClass({
		render: function() {
			var startAt = 0
			var htmlPoss = this.props.bar.content.map(function(step) {
				var html = (<HtmlPos startAt={startAt} step={step}/>)
				startAt += step.beats
				return html
			})
			return (
				<div className={this.getClassName()}>
					{htmlPoss}
				</div>
			)
		},
		getClassName: function() {
			var classes = [
				'sheet-bar',
				'bar-'+this.props.bar.signature.beats
			]
			if (this.props.bar.beatsToAdd !== 0) {
				// la mesure est incomplète ou trop grande
				classes.push('bad-bar')
			}
			classes.push('b_' + this.props.bar.content.map(get('beats')).join('-'))
			return classes.join(' ')
		}
	})
	var HtmlPos = React.createClass({
		render: function() {
			return (
				<div className={this.getClassName()}>
					{this.props.step.chord}
				</div>
			)
		},
		getClassName: function() {
			var classes = [
				'sheet-step',
				's_'+[this.props.startAt,this.props.step.beats].join('-')
			]
			return classes.join(' ')
		}
	})
	var HtmlSignature = React.createClass({
		render: function() {
			var s = this.props.signature
			return (
				<div className="sheet-signature">
				{s.beats}
					<br/>
				{s.size}
				</div>
			)
		}
	})
</script>
<script>

	function get(k) {
		return function (o) { return o[k] }
	}


	// -- DataTypes -------------------------------------------------------

	function Pos(chord,beats) {
		this.chord = chord
		this.beats = beats || 1
	}
	function Signature(beats,size) {
		this.beats = beats || DEFAULT_SIGNATURE_BEATS
		this.size = size || DEFAULT_SIGNATURE_SIZE
	}
	function Bar(content,signature) {
		this.content = content
		this.beatsToAdd = signature.beats
		this.signature = signature
	}
	Bar.prototype.addPos = function(step) {
		this.beatsToAdd -= step.beats
		this.content.push(step)
	}

	function RowJump(){}
	function BarSeparator(){}
	// function RepeatLeft(){}
	// function RepeatRight(){}
	// RepeatLeft.prototype = new BarSeparator
	// RepeatRight.prototype = new BarSeparator

	/**
	 * Transforms a raw list of steps into Bar's (groups of Pos's). The other
	 * types of step are not changed
	 * @param  {Array}
	 * @return {Array}
	 */
	function stepsToSongList(steps) {
		// ici on va créer les mesures en groupand chaque Pos jusqu'à ce
		// que la somme de leurs beats soit égale au beats de la signature
		// courante
		if (!steps.length) return []
		// On regarde si notre morceau commence par une signature. Si ce n'est
		// pas le cas on ajoute la signature par défaut
		var startSignature = (steps[0] instanceof Signature
								? steps.shift()
								: new Signature)
		// On commence à boucler sur tous nos steps. On retient la Signature
		// courante pour l'associer à chaque Bar
		var currentSig = startSignature
		var currentBar = new Bar([],currentSig)
		var list = [currentSig,currentBar]
		steps.forEach(function(step){
			if (step instanceof Pos) {
				if (step.beats > currentSig.beats) {
					throw new Error("Pos larger thant what bar signature allows",step,currentBar)
				}
				// si la Bar est complète (ou que la Pos ne rentre pas) on crée
				// une nouvelle Bar
				if (step.beats > currentBar.beatsToAdd) {
					currentBar = new Bar([],currentSig)
					list.push(currentBar)
				}
				// Enfin on ajoute la Pos à la Bar
				currentBar.addPos(step)
			}
			// quand on change de signature, on crée une nouvelle bar
			// automatiquement. La Signature est directement stockée dans la
			// liste renvoyée. De plus, elle devient la nouvelle currentSig
			else if (step instanceof Signature) {
				currentSig = step
				currentBar = new Bar([],currentSig)
				list.push(step)
				list.push(currentBar)
			}
			// Sinon c'est autre chose, un RowJump, une Coda ou autre, on le met
			// simplement dans la liste
			else {
				list.push(step)
			}
		})
		return list

	}

	/**
	 * Prend une songlist (cf stepsToSongList) et renvoie les objets groupés
	 * en Row's
	 * @param  {Array}
	 * @return {Array}
	 */
	function songListToRows (list) {
		if (!list.length) return []

		var currentRow = []
		var rows = [currentRow]
		list.forEach(function(item){
			l('item',DEBUG_getItemClass(item))
			// avant une Bar on met un BarSeparator
			if (item instanceof Bar) {
				currentRow.push(new BarSeparator)
			}
			// Si on a un rowjump, on change de row.
			if (item instanceof RowJump) {
				currentRow = []
				rows.push(currentRow)
			}
			// Si pas un RowJump, (Bar compris), on push l'item
			else {
				currentRow.push(item)
			}
		})
		// Enfin, on revoit now rows
		// Si l'une se finit par une Bar, on ajoute un BarSeparator
		rows.forEach(function(row){
			if (row[row.length-1] instanceof Bar) {
				row.push(new BarSeparator)
			} else {
				l('last item',row[row.length-1])
			}
		})
		l('rows',rows)
		return rows
	}


	var l = console.log.bind(console)

	function DEBUG_getItemClass(item) {
		switch(true) {
			case item instanceof Bar:         	return 'Bar'
			case item instanceof BarSeparator:	return 'BarSeparator'
			case item instanceof Pos:         	return 'Pos'
			case item instanceof RowJump:     	return 'RowJump'
			case item instanceof Signature:   	return 'Signature'
		}
	}

	function DEBUG_randomNote(item) {
		// get the note
		var noteNum = parseInt(Math.random() * 7)
		var note = "ABCDEFG"[noteNum]
		var alter = parseInt(Math.random() * 5)
		if (alter === 1) note += '#'
		else if (alter === 2) note += 'b'
		// else no alter
		// tierce
		var minor = parseInt(Math.random() * 2)
		if (minor) note += 'm'
		// septieme
		var sept = parseInt(Math.random() * 4)
		if (sept === 1) note += '7'
		else if (sept === 2) note += '7M'

		return note
	}

	function serializeTrack(track) {
		/*
			Ici, transformer la track en de simple objets (pas des new XXX)
			avec des noms de propriétés raccourcis et en précisant la classe,
			genre myObject._c = 'Pos'
		*/
		return 'serialized ...'
		return Bencode.encode(track)
	}

	// @todo sur l'IHM empêcher d'ajouter un RowJump en tout début de steps

</script>

<script type="text/jsx">
	var track = {
		title:"Some Ol' Song",
		steps: [

			// Blues
			new Pos('I',4),
			new Pos('I',4),
			new Pos('I',4),
			new Pos('I',4),
			new RowJump(),
			new Pos('IV',4),
			new Pos('IV',4),
			new Pos('I',4),
			new Pos('I',4),
			new RowJump(),
			new Pos('V',4),
			new Pos('IV',4),
			new Pos('I',4),
			new Pos('I',4)
		]
	}
	var rows = songListToRows(stepsToSongList(track.steps))
	l('rows',rows)
	React.render(
		<Paper rows={rows} title={track.title}/>,
		document.getElementById('paper-wrapper')
	)


	console.log('Track',serializeTrack(track))

</script>
